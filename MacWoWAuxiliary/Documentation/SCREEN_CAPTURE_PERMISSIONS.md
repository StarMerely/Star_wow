# 屏幕截图权限配置指南

## 🚨 问题：截图是空白的

如果你发现截图保存后是空白的，这是因为**没有授予屏幕录制权限**。

---

## ✅ 解决方法

### 步骤 1: 打开系统设置

```
1. 点击左上角  图标
2. 选择 "系统设置"
```

或者使用快捷键：
```
⌘ + 空格 → 输入 "系统设置" → 回车
```

---

### 步骤 2: 进入隐私与安全性

```
1. 在系统设置中，点击左侧 "隐私与安全性"
2. 在右侧找到 "屏幕录制"
```

路径：
```
系统设置 → 隐私与安全性 → 屏幕录制
```

---

### 步骤 3: 授予权限

```
1. 点击左下角的 🔒 锁图标
2. 输入密码解锁
3. 找到 "MacWoWAuxiliary" 应用
4. 勾选应用旁边的复选框 ✅
5. 点击 🔒 锁图标锁定
```

**重要**: 如果列表中没有看到应用：
```
1. 点击 "+" 按钮
2. 找到应用程序文件夹
3. 选择 MacWoWAuxiliary.app
4. 点击 "打开"
5. 勾选复选框
```

---

### 步骤 4: 重启应用

**必须重启应用才能生效！**

```
1. 完全退出应用 (⌘ + Q)
2. 重新启动应用
3. 测试截图功能
```

---

## 🔍 如何验证权限是否生效

### 方法 1: 查看控制台日志

运行应用后，查看 Xcode 控制台或系统日志：

**权限正常**:
```
📐 屏幕尺寸: 1920x1080
✅ 屏幕截图成功: 1920x1080
📊 图片数据大小: 8294400 字节
```

**权限缺失**:
```
📐 屏幕尺寸: 1920x1080
✅ 屏幕截图成功: 1920x1080
📊 图片数据大小: 8294400 字节
⚠️ 截图内容为空白，可能是权限问题
💡 解决方法:
   1. 打开 系统设置 -> 隐私与安全性 -> 屏幕录制
   2. 找到本应用并勾选
   3. 重启应用
```

---

### 方法 2: 打开截图文件

```
1. 点击 "📂 打开截图" 按钮
2. 查看 ~/Documents/tmp/ 目录
3. 打开最新的 screenshot_xxx.png 文件
4. 检查是否能看到屏幕内容
```

**正常截图**:
- ✅ 能看到完整的屏幕内容
- ✅ 文字清晰可见
- ✅ 颜色正常

**空白截图**:
- ❌ 全黑或全白
- ❌ 没有任何内容
- ❌ 文件大小很小

---

## 🎯 macOS 版本差异

### macOS 13 Ventura 及以上

```
系统设置 → 隐私与安全性 → 屏幕录制
```

### macOS 12 Monterey

```
系统偏好设置 → 安全性与隐私 → 隐私 → 屏幕录制
```

### macOS 11 Big Sur 及以下

```
系统偏好设置 → 安全性与隐私 → 隐私 → 屏幕录制
```

---

## 🔧 高级调试

### 检查权限状态（代码）

```swift
import AVFoundation

func checkScreenRecordingPermission() {
    if #available(macOS 10.15, *) {
        let hasPermission = CGPreflightScreenCaptureAccess()
        print("屏幕录制权限: \(hasPermission ? "已授予" : "未授予")")
        
        if !hasPermission {
            // 请求权限
            CGRequestScreenCaptureAccess()
        }
    }
}
```

---

### 手动请求权限

在应用启动时添加：

```swift
// AppDelegate.swift 或 ContentView.swift

func applicationDidFinishLaunching(_ notification: Notification) {
    // 检查并请求屏幕录制权限
    if #available(macOS 10.15, *) {
        if !CGPreflightScreenCaptureAccess() {
            print("⚠️ 需要屏幕录制权限")
            CGRequestScreenCaptureAccess()
        }
    }
}
```

---

## 📋 常见问题

### Q1: 已经授予权限但还是空白？

**解决方法**:
```
1. 在系统设置中取消勾选应用
2. 点击 "-" 按钮移除应用
3. 重新添加并勾选
4. 重启应用
```

---

### Q2: 列表中找不到应用？

**原因**: 应用还没有请求过权限

**解决方法**:
```
1. 运行应用并尝试截图
2. 系统会弹出权限请求对话框
3. 点击 "打开系统设置"
4. 按照上面的步骤授予权限
```

---

### Q3: 授予权限后需要重启 Mac 吗？

**不需要**，只需要重启应用即可。

---

### Q4: 截图有内容但是模糊？

这不是权限问题，可能是：
```
1. 屏幕分辨率设置问题
2. Retina 显示屏缩放问题
3. 截图质量设置问题
```

**解决方法**:
```swift
// 使用更高质量的截图选项
let cgImage = CGWindowListCreateImage(
    screenRect,
    .optionOnScreenOnly,
    kCGNullWindowID,
    [.bestResolution, .boundsIgnoreFraming]  // 最佳分辨率
)
```

---

### Q5: 只能截取部分屏幕？

**原因**: 可能是多显示器设置问题

**解决方法**:
```swift
// 截取所有屏幕
let screens = NSScreen.screens
for (index, screen) in screens.enumerated() {
    let rect = screen.frame
    let image = CGWindowListCreateImage(rect, .optionOnScreenOnly, kCGNullWindowID, [])
    print("屏幕 \(index): \(rect)")
}
```

---

## 🛡️ 安全说明

### 为什么需要屏幕录制权限？

```
屏幕录制权限允许应用：
✅ 截取屏幕内容
✅ 识别屏幕上的文字（OCR）
✅ 自动化操作

不会：
❌ 录制视频
❌ 上传数据
❌ 监控用户行为
```

### 权限范围

```
授予权限后，应用可以：
- 截取整个屏幕
- 截取特定窗口
- 截取特定区域

应用不会：
- 自动上传截图
- 保存敏感信息
- 后台录制
```

---

## 📊 权限检查清单

在使用 OCR 功能前，请确认：

- [ ] 已在系统设置中授予屏幕录制权限
- [ ] 应用已重启
- [ ] 控制台显示截图成功
- [ ] 截图文件不是空白的
- [ ] OCR 能识别到文字

---

## 🎯 快速测试

### 测试步骤

```
1. 打开应用
2. 切换到 OCR 标签页
3. 输入文字: "测试"
4. 点击 ▶️ 开始
5. 查看控制台日志
6. 点击 📂 打开截图
7. 检查截图内容
```

### 预期结果

**成功**:
```
📐 屏幕尺寸: 1920x1080
✅ 屏幕截图成功: 1920x1080
📊 图片数据大小: 8294400 字节
📸 图片 OCR 识别完成: 15 个文字区域
```

**失败**:
```
📐 屏幕尺寸: 1920x1080
✅ 屏幕截图成功: 1920x1080
📊 图片数据大小: 8294400 字节
⚠️ 截图内容为空白，可能是权限问题
```

---

## 💡 提示

### 开发环境

如果在 Xcode 中运行：
```
1. Xcode 本身需要屏幕录制权限
2. 在系统设置中同时授予 Xcode 和应用权限
3. 重启 Xcode 和应用
```

### 发布版本

如果是打包后的应用：
```
1. 只需要授予应用本身的权限
2. 不需要授予 Xcode 权限
```

---

## 📞 仍然无法解决？

如果按照上述步骤操作后仍然无法截图：

1. **检查 macOS 版本**
   ```
   关于本机 → macOS 版本
   需要 macOS 10.15 或更高版本
   ```

2. **检查应用签名**
   ```
   codesign -dv /path/to/MacWoWAuxiliary.app
   ```

3. **重置权限**
   ```
   tccutil reset ScreenCapture
   ```
   然后重新授予权限

4. **查看系统日志**
   ```
   打开 控制台.app
   搜索 "MacWoWAuxiliary"
   查看错误信息
   ```

---

**记住：授予权限后必须重启应用！** 🔄
